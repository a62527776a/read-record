# 操作系统层

操作系统层是一个在指令系统层提供的指令和特性之上又增加指令和特性的程序。

操作系统层总是解释执行的。

## 6.1 虚拟内存

自动执行**覆盖段**的过程

覆盖段：程序分为很多片段。

### 6.1.1 内存分页

地址空间大于实际内存空间。  

在拥有虚拟内存技术的计算机上，访问不存在的物理地址空间，会从内存映射表中查询对应虚拟内存空间，将对应的页从磁盘中读取到内存中。程序继续执行。

程序使用的地址空间被称为虚拟地址空间  
实际的物理内存地址被称为物理地址空间  

通过内存映射表的方式在虚拟地址空间和物理地址空间之间建立联系。

### 6.1.2 内存分页的实现

虚拟地址空间被分为大小相等的页  
物理地址空间被分为大小相等的片  

这样每一片能装下每一页。

内存中的片被称为页帧。

内存管理单元用于完成虚拟地址空间与物理地址空间的映射。

### 6.1.3 请求调页和工作集模型

缺页：当发现页不在内存中时，前往辅助存储器读取指定的页，所有的页都默认在辅助存储器上

### 6.1.4 页置换策略

常见的两种：
1. LRU算法 （Least Recently Used） 移走最近最少使用的页
2. 先进先出（FIFO） 移走最早调入内存的页

### 6.1.5 页大小和碎片

碎片的产生：最后一个不能装填满的页 在内存中还是会占用一整页，这会导致这一整页无法被使用。

小页需要更多的页，以及更大的页表以及更高的成本。

小页在磁盘传输中会更加低效。

小页不容易出现系统颠簸

### 6.1.6 分段

提供多个完全独立的地址空间。称为段。 

每个段由不同的地址空间组成。（每个段被隔离）

每个段都是一个从0开始的线性地址序列。

每个段可以有不同长度。

优势：
1. 每个过程都使用单独的段，那么每个过程都从地址0开始，修改并重新编译其中一个段 不影响其它的过程。因为它们的地址是隔离的。
2. 便于共享过程和数据

### 6.1.7 分段的实现

交换和分页

交换：段从内存和磁盘中来回移动
换页：每个段有相同大小，方式与分页一致

实现的方式类似，主要是机制不同。

段也可以分页 每个段都有自己的页表。

### 6.1.10 虚拟内存和高速缓存

虚拟内存：整个程序被保存在磁盘中并被分为固定大小的页，被用到时，才会将页保存在内存中。这样程序将会运行的很快

高速缓存：程序在内存中被分为固定大小的缓存块，某些块被放在高速缓存中。

## 6.3 操作系统I/O指令

### 6.3.1 文件

打开文件，操作系统在磁盘中查找文件并把访问文件需要的信息调入内存。

读取文件，必须至少有
1. 指示去读哪个被打开文件的指示符
2. 指向存放数据的内存缓冲区的指针
3. 要读取的字节数

每个打开的文件都有一个指向下一个要读取字节的指针。用来指示顺序读取数据块。

读完文件后，需要有一个关闭操作，这样操作系统就会释放保存文件信息的表空间。

### 6.3.2 操作系统层I/O指令的实现

### 6.3.3 目录管理单元

目录本身也是一个文件

## 6.4 用于并行处理的操作系统指令

在具有多个CPU的计算机上，可以为每个协作进程分配一个CPU。如果只有一个，就让CPU按照小的时间间隔轮流运行每个进程来模拟并行处理。

## 6.4.1 进程创建

进程：由状态和使程序和数据能够访问的地址空间来区分，状态至少包括 程序计数器 程序状态字 通用寄存器。

### 6.4.2 竞争条件

并行进程间需要互相通信和同步

### 6.4.3 使用信号量的进程同步

拥有一个状态 通过信号量增减该状态 到达指定值再接收到指定信号量则执行操作。
