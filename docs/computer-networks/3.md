# 数据链路层

用于实现相邻机器通过通信信道实现可靠有效的完整信息块的通讯。

## 3.1 数据链路层的设计问题

数据链路层需要完成
1. 向上层提供良好的服务接口
2. 处理传输错误
3. 调节数据流
   
数据链路层接受上层（网络层）的数据包，并封装成帧。

帧包含帧头 有效载荷 帧尾

### 3.1.1 提供给网络层的服务

数据链路层的主要服务就是将数据从源机器的网络层发送给目标机器的网络层。

数据链路层一般提供

1. 无确认无连接服务
   1. 不建立连接，不检测丢帧，不试图恢复
   2. 场景：实时通讯，错误率低的场景
   3. 示例：以太网
2. 有确认无连接服务
   1. 不建立连接，每帧单独确认，超时重发
   2. 场景：不可靠信道
   3. 示例：WIFI 无线系统
4. 有确认有连接服务
   1. 每一帧都将建立连接 编号。保证数据接受顺序。确保每一帧都被接受。
   2. 场景：长距离不可靠链路
   3. 实例：长途电话，卫星信道

#### 有确认无确认的无连接服务区别

对于网络层来说，只要超时，网络层只需要重新发送就行。

链路层有确认服务的每一帧需要被单独确认。所以开销要大于无确认连接。

但当遇到丢帧的情况时，无确认服务就需要依赖上层网络层超时后来重新发送整个报文。

而有确认服务只需要链路层自身来处理单个帧超时后的重传。

 -------------------------------------------------

#### 有确认无确认的无连接服务区别

当接收到网络层的数据包时，链路层会根据包大小拆分为多个帧。

如果有其中1帧在传输中被丢失。

如果是无确认服务，那么将会等待到上层网络层超时重新发送整个数据包。

如果是有确认连接，那么链路层将会在这个帧超时后重新单独发送这个帧，而不会等待网络层处理。

所以无确认连接更适合使用在可靠信道，有确认连接更适合在无线信道。

#### 面向连接服务的建立

1. 初始化变量计数器，用来确认帧是否被接收到。
2. 传输数据帧
3. 变量 缓冲区 以及其他资源被释放

### 3.1.2 成帧

数据链路层接受物理层的比特流，并将比特流拆分为多个帧。

为每个帧计算成为校验和的短令牌并检测错误以及纠正错误，是数据链路层的工作之一。

校验和会同帧一起被传输。

#### 如何检测错误

帧发送到目标机器后，会重新计算校验和，并和帧中携带的校验和进行比对。如果校验和不同，就意味着出错

#### 拆分比特流的常见方案

1. 字节计数法
   1. 帧头字段标示帧字节数
2. 字节填充的标志字节法
   1. 特殊字节标示帧头帧尾
3. 比特填充的标志比特法
   1. 帧开始和结束由特殊的比特模式来标记
4. 物理层编码违禁法
   1. 没看懂 但是这个比较常用

注意：填充的字节和比特 都会在成帧之前被剔除。这意味着只会出现在物理层的字节流中。

### 3.1.3 差错控制

确保可靠传递，接收方在接收到帧之后会发回特殊的控制帧，用来确认或者否定是否正确发送。

为避免确认帧接受失败，数据链路层会引入计时器。

为避免接收到重复帧，每个帧都会被分配需要。

管理好计时器和序号，确保每一帧都被恰好一次的传递给目标机器网络层。是数据链路层的重要工作之一。

### 3.1.4 流量控制

如何处理当发送方发送帧的速度超过了接收方能接收帧的速度。

#### 常见的流量控制
1. 基于反馈的流量控制
   1. 接收方给发送方信息
2. 基于速率的流量控制
   1. 限制发送方传输数据速率

## 3.2 差错检测和纠正

针对错误处理 通常采用在发送的数据中加入冗余信息。
在此之上，衍生了两种策略

1. 通过冗余信息来推断被发送的数据
2. 通过冗余信息来推断是否发生错误

前者使用纠错码 后者使用检错码

一般来说，在可靠信道上，使用检错码
无线信道上，使用纠错码

### 3.2.1 纠错码

常见的纠错编码

1. 海明吗
2. 二进制卷积码
3. 里德所罗门码
4. 低密度奇偶校验吗

一帧由m个数据为和r个冗余位组成。

块码 系统码 线性码使用不同的编码方式。

数据块总长度称为n。一个包含m 和 r的数据块称为n位码字。

码字中不包含冗余位的比例被称为码率。


#### 海明码

通过异或两个码字来确认是否有错

```
10001001 
10110001
--------
00111000
```

不相同位个数被称为海明距离

海明码的纠错方式

当校验结果非0 就将错误的位取反 并丢弃校验位

#### 二进制卷积码
没看懂
#### 里德所罗门码
没看懂
#### 低密度奇偶校验吗
没看懂

### 3.2.2 检错码

检错码 多用于可靠信道

对于偶尔发生的错误采用差错检测和重传的处理方式 更加有效

常用的检错码

1. 奇偶
2. 校验和
3. 循环冗余校验

#### 奇偶

将奇偶校验位附加到数据中 使得码字中比特1的数量为奇数或者偶数

接收方通过奇偶校验位以及码字是否为奇偶数来得知数据是否出错。

缺点是只能检测出1位的错误

如果出现乱七八糟的错误，检错概率将会大大降低

#### 校验和

校验和通常指于信息相关的校验位。

校验和 基础是对消息中的数据位进行求和。

对码字进行求和计算，来检测错误。如果和为0，则没有错误

#### 循环冗余校验码

看不懂

## 3.3 基本数据链路层协议

#### 数据链路层传输数据流程

数据链路层从网络层接收到数据包  
⬇️  
数据链路层将数据包封装到帧中，并给帧头增加控制信息 帧尾增加校验和  
⬇️  
数据链路层将帧发出  
⬇️  
目标机器数据链路层接收到帧  
⬇️  
目标机器数据链路层计算帧校验和   
⬇️  
目标机器数据链路层根据控制信息处理校验和正确的帧  
⬇️  
目标机器数据链路层将正常的帧中内嵌的数据包传递给网络层  

##### 数据包与帧

网络层从传输层获得报文，并在报文上增加网络层头 由此创建了一个数据包

数据包被传递到数据链路层 然后被放到输出帧中 发送到目标机器

目标机器数据链路层提取帧中的数据包 将数据包传递给网络层。

##### 应对丢失帧

每个被发出的帧 都启动一个定时器，超时都收到信号


### 3.3.1 乌托邦式的单工协议


### 3.3.2 无错信道上的单工停等式协议

通过接收方给发送方反馈信息的方式，来控制发送方是否允许发送。

用来解决发送方以高于接收方能处理到达帧的速度发送帧导致接收方被淹没的问题

采用严格的交替关系。既发送方在发送下一个数据包前必须等待前一个数据包确认帧到来。

### 3.3.3 有错信道上的单工停等式协议

发送方和接收方记录下一个要发送帧和下一个要接受帧的序号，用来避免由于超时重传导致的重复帧的接受

## 3.4 滑动窗口协议

目标：维持发送的顺序

滑动窗口的特点
1. 发送方窗口维护允许发送的帧
2. 发送方窗口内的序号代表可以发送以及已发送未确认的帧
3. 当从网络层接收新数据包 帧将被赋予到滑动窗口中的最高序号 并且上边界将前移 当确认返回 发送窗口下边界将前移
4. 接收方窗口维护允许接受的帧 被接收到的窗口内的帧将被放入缓冲区 窗口外的帧 将被抛弃
5. 接收到的帧序号等于接收方窗口下边界的序号。这个帧将被提交到网络层，并将窗口前移
6. 接收到的帧序号不再接收方窗口内 将被抛弃

接收到的帧 不一定是按照顺序的
如果不是接收顺序的下边界 会被放到缓冲区

当下边界移动到已接收到的帧时 就会提交到网络层

每次移动下边界 会检查缓冲区内是否有下边界的帧

这样来保证按照顺序递交

#### 捎带确认

不单独发送确认帧，而是将确认信息附加到下一个需要发送的帧中。
如果新的数据包很快到来 那么确认将会被附带
如果间隔超时，将单独发送确认帧

#### 控制流量

当窗口达到最大尺寸 将关闭网络层 直到有空余

#### 重传

内存中将缓存所有进入发送窗口的帧，用于满足传输丢失或者损坏的重传需求



### 3.4.1 一位滑动窗口协议

。。
。。
。。
。。
。。
。。
。。

看不动了
