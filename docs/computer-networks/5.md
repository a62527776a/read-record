# 网络层

将源端数据包一路送到接收方。处理端到端的数据传输。

数据链路层将帧从一边传送到另一边。

网络层需要在网络拓扑结构中寻找最适当的路径。

## 5.1 网络层的设计问题

### 5.1.1 储存转发数据包交换

#### 储存转发机制
数据包通过数据链路层从主机发送到路由器上后，
路由器将数据包储存下来，并且沿着路径将数据包转发到下一个路由器上

### 5.1.2 提供给传输层的服务

设计网络层服务目标

1. 向上提供的服务应独立于路由器技术
2. 向传输层屏蔽路由器数量 类型 拓扑结构
3. 传输层可用网络地址应该有统一编址方案

网络层提供两种类型的服务

1. 无连接的服务
2. 面向连接的服务

#### 无连接的服务

1. 数据包独立注入网络
2. 每个数据包独立路由
3. 不需要提前建立任何设置

这种数据包成为数据报，这种类型的网络被称为数据报网络

#### 面向连接的服务

1. 提前建立从原路由器到目标路由器的路径

这种连接被称为虚电路，这种类型的网络被称为虚电路网络

### 5.1.3 无连接服务的实现

路由器拥有一个内部表
内部表拥有两个字段 分别表示
1. 可能的目标路由器地址  
2. 如果要前往这个目标路由器，那么下一个路由器应该是哪一个？

|  目标路由器地址  | 下一个路由器地址  |
|  ----  | ----  |
| D  | B |
| E  | C |

假设当前这个数据包在A  
目标路由器为D  
那么这个数据包下一个路由器将被转发到B路由器上

![911612068885_.pic.jpg](https://i.loli.net/2021/01/31/aCtRKx6JlPXQvj9.jpg)

出于某些原因 路由表会被更新，  
管理路由表并做出路由选择的算法被称为**路由算法**

#### IP协议

IP协议是整个Internet的基础，是无连接网络服务的重要范例。  

每个数据包携带目标IP地址。  

路由器使用该地址单独转发每一个数据包。  

### 5.1.4 面向连接服务的实现

目标：避免为每个要发送的数据包选择一条新路径

当建立一个连接时 源机器到目标机器的路径就被确认下来。  
并且保存在中间路由器的表里

每个面向连接服务的数据包都会一个指明它属于哪一条虚电路。

每个路由器会记录沿经的每一条虚电路在当前路由器上的出入径目标

当连接被释放，将清理对应的虚电路。

C路由器表

入径表

|  上一个路由器  | 属于哪一条虚电路  |
|  ----  | ----  |
| A  | 1 |
| A  | 2 |

出径表

|  下一个路由器  | 属于哪一条虚电路  |
|  ----  | ----  |
| E  | 1 |
| E  | 2 |

![921612069829_.pic.jpg](https://i.loli.net/2021/01/31/rPo9ZGFa3E5XupR.jpg)

### 5.1.5 虚电路与数据包网络的比较

虚电路网络需要建立连接 这个阶段耗费时间资源
但是传输阶段消耗资源更少 传输数据包更加简单

数据包网络需要用更加复杂的路由查找来寻找目标

数据包网络中的每个数据包都需要携带完整的目标IP地址
而虚电路只需要携带比较少的路由器索引即可

数据包网络中，需要保存大量的目标地址表项目
虚电路网络中，只需要记录虚电路的表项

## 5.2 路由算法

网络层的主要功能是将数据包从源机器路由到目标机器。
选择并设计路由算法是网络层设计的主要内容

如果使用数据包网络 则在每个数据包到来时，路由器都需要进行路由决策  
如果使用虚电路网络 则只有在建立虚电路时，路由器才需要进行路由决策

#### 路由算法分类

1. 自适应算法
2. 非自适应算法

### 5.2.1 优化原则

最优化原则

如果存在一条最优化路径 A -> B -> C -> D -> E

那么C -> E的最优化路径一定也遵循同样的路由

### 5.2.2 最短路径算法

测量路径长度 
两种常见的方法
1. 按照跳数
2. 按照距离


Dijkstra 最短路径算法

https://www.cnblogs.com/jason2003/p/7222182.html


### 5.2.3 泛洪算法

将入径数据包发送到每一条出径线路  
会导致发送大量重复数据包  


### 5.2.4 距离矢量算法

每个路由器维护到目标路由器的最佳距离以及链路

通过和相邻路由器之间交换信息而保持更新

-----------------------
以延迟作为最佳距离度量值

路由器A向所有相邻的路由器发送一个特殊的数据包，所有相邻的数据包收到后 返回时间戳。那么就得到了路由器A相邻的每一跳的延迟。每个路由器都共享相邻路由器的延迟列表。  

通过共享的路由器延迟列表来计算到目标路由器的最佳距离。

#### 无穷计算问题 

看不懂 总之由于无穷计算问题 这个算法已经被抛弃

当网络拓扑结构发生变化 会出现无穷计数问题    
这会导致需要太长时间才能收敛到稳定状态  

### 5.2.5 链路状态路由算法

由于无穷计算问题 链路状态路由取代了距离矢量算法

该算法的变种，已经成为大型网络或Internet应用最为广泛的路由算法

#### 链路状态算法的步骤

1. 发现邻居节点 并了解其网络地址
2. 设置到每个邻居节点的距离或者成本度量值
3. 构造一个包含所有刚刚获知的链路信息包
4. 将这个包发送给所有其他路由器 并接收所有其他路由器的信息包
5. 计算出到每个其他路由器的最短路径

#### 发现邻居

路由器启动后向每条点对点线路上发送包，并且接收其他路由器的返回包。以找出所有的邻居路由器

#### 设置链路成本

通常使用与带宽成反比的度量方式

或者以链路延迟作为度量方式

#### 构造链路状态包

将上述信息收集后构造包含所有信息的数据包

#### 分发链路状态包

通过泛洪法来分发 并且进行一定的改进来规避问题

#### 计算新路由

当路由器积累了全部链路状态数据包，就可以构造出完整网络图。

每条链路会被表示两次，不同方向各一次。

A -> B 和 B -> A 的最短路径有可能是不一样的。

在路由器上运行Dijkstra 最短路径算法来构建出从本地到所有可能目标目的地的最短路径。

**著名的IP协议就是基于这个算法改进的**

### 5.2.6 层次路由

由于网络规模越来越大 路由表计算越来越困难。 路由分层不得不进行。

路由器被划分为区域。每个路由器知道如何将数据包路由到自己所在区域的目标地址。

### 5.2.7 广播路由

.....

### 5.2.11 自组织路由

..... 

看不动

## 5.3 拥塞控制算法

控制拥塞最有效的方案 是减少传输层注入网络的负载

拥塞：突发的流量占满路由器内部缓冲区 导致**某些数据包**被丢失 这些被丢失了一部分的数据包消耗了部分容量

拥塞奔溃：随着注入负载超出网络容量。网络性能骤降。

表现：数据包花在等待积压在前面数据包排空的时间远远超过了允许其在网络中的最大生存期，因此不得不被丢掉，这种包会被认定为丢失，发送方会重传这个包。导致浪费了网络容量。

加大路由器内存会使拥塞奔溃更加严重，因为当数据包排到队列前面的时候，它会早已过期，并且超时副本也会被发送

### 5.3.1 拥塞控制的途径

1. 增加资源以预先避免拥塞
2. 减少负载以处理拥塞的情况

流量感知路由：通过改变最短路径权重，来更改数据包路由，使得流量远离频繁使用的路径

准入控制：在虚电路网络中，拒绝新连接的建立

拥塞控制：给数据包源端反馈信息，要求源端抑制流量，或者缓解流量本身。

为了实现拥塞控制 要解决以下两个问题

1. 如何确定网络开始拥塞：路由器监控平均负荷 排队延迟 丢包情况
2. 如何通知源端减缓速度：路由器参与到源端反馈循环

负载脱落：选择一个良好的丢弃数据包策略

### 5.3.2 流量感知路由

计算路由时考虑链路负载  
这种方案由于不稳定性 不被Internet路由协议采用。

### 5.3.3 准入控制

准入控制常用于虚电路网络，除非网络可以携带额外流量而不会变得拥塞，否则不再建立新的虚电路。

通过**漏桶**或**令牌桶**来确认网络是否拥塞

和流量感知路由结合 在虚电路网络建立过程中，避开流量热点地区。

### 5.3.4 流量调节

为了避免拥塞 需要即时告知发送方降低传输速度

限制流量必须解决两个问题
1. 路由器何时快要接近拥塞
   1. 需要检测输出线路的利用率
   2. 路由器缓冲区内的排队数据包
   3. 由于没有足够的缓冲区而丢失的数据包数量
2. 路由器需要将反馈信息即时传递给造成拥塞的发送方

#### 抑制包

路由器选择一个被拥塞的数据包。给该数据包的源主机返回一个抑制包。抑制包的目标地址取自该数据包。同时给该数据包打上标记，使其后路径上的路由器不会再产生抑制包

#### 显式拥塞通知

拥塞的路由器在转发的数据包上打上标记，以告知接收方该路由器正经历拥塞。，接收方数据包并读取到拥塞标记，会在发送应答包时顺便告知发送方，使发送方得知拥塞。

特点：接收方在下一个应答数据包中回显标志作为显式拥塞信号。

#### 逐跳后压

当网络速度高，距离远等导致传播延迟的缘故，会导致在拥塞信号发出后到产生作用期间，会有大量新的数据包被注入网络。

逐跳后压指拥塞信号发出的每一跳都进行减缓数据流量。

由于在回到源发送端的每一跳的过程中都会抑制流量，但源发送端并不会降低发送速率。所以每一跳都需要分配更多的缓冲区，直到拥塞信号回到源发送端，数据包流才会真的被减缓。

### 5.3.5 负载脱落

通过一些策略来丢弃数据包。

## 5.4 服务质量

### 5.4.1 应用需求

流：从源端到接收端的数据包流

面向连接的网络中，流是连接上的所有数据包
无连接网络中，流是从一个进程到另一个进程的所有数据包

一个流的服务质量由4个主要参数决定
1. 带宽
2. 延迟
3. 抖动
4. 丢失

抖动：延迟的变化

### 5.4.2 流量整形

流量整形：调节进入网络的数据流平均速率和突发性所采用的技术

流量整形技术可以减少拥塞

#### 漏桶 和 令牌桶

用于流量整形 和 监管

每一个网络接口都有一个漏桶，每个数据包都会在漏桶外排队。
如果漏桶满了 则抛弃数据包。
数据包流通过**漏桶的小洞**（指一定的速率）发出

这样 即时瞬间出现大量流量，也会按照一定的速率流出。

限制流的长期速率。允许短期突发大量流量。

以避免网络拥塞

令牌桶 和 漏桶类似。

都是统一流量输出速率。

数据包必须排队并延迟到桶允许被发送的时候。

### 5.4.3 包调度

为了保证服务质量，必须为数据包路径的预留足够的资源。

为同一个流的数据包以及竞争流之间分配路由器资源的算法称为包调度算法。

为不同的流预留潜在资源：
1. 带宽
2. 缓冲区
3. CPU周期

#### FIFO 先入先出

队列的形式发送数据包

尾丢包：队列满时丢弃新到的数据包

缺点：无法提供良好的服务质量，容易影响其他流的发送。当A流注入大数据包，进入的B流将会一直延迟在A流之后。

。。。 还有一些比较好的调度算法

### 5.4.4 准入控制

#### QoS路由

服务质量保证的路由。

1. 发起一个有QoS需求的流量
2. 网络根据自己的容量以及其他流的承诺决定是否接收或拒绝流
3. 如果接收，网络就需求在路由器上预留容量，以保证流的服务质量
4. 数据包沿经的每个路由 都需要预留资源
5. 通过路由算法寻找满足QoS需求的路径


#### 流规范
由发送方 接收方 以及 途径的路由器共同协商的参数

通常由发送方发起一组参数，由途径的路由器检查并降低相关的质量参数。
到达接收方时 流规范就被建立起来了。

### 5.4.5 综合服务

### 5.4.6 区分服务

## 5.5 网络互联

使用Internet来连接不同的网络。

### 5.5.1 网络如何不同

Internet抹除不同网络之间的差异

### 5.5.2 何以连接网络

两种基本方案
1. 将每种数据包翻译或转换成另一种数据包
2. 在不同网络上构造一个公共层

IP提供了一种通用数据包格式，所有路由器都能识别这种数据包

IP是现代Internet基础

IP 就是Internet 协议

不同的网络 有着不同形式的地址。

数据包在不同网络间传输过程：
1. 源端从传输层接收数据 并生成带有公共网络层的头，比如IP协议
2. 网络层头包含最终的接收方地址
3. 数据包被封装在帧中 帧的目标地址是第一个路由器
4. 在第一个路由器中，数据包从帧的数据字段中提取出来 帧头被抛弃
5. 通过数据包的IP地址来检查路由表，并得知下一个路由器地址
6. 根据下一个路由器地址 来将数据包再次封装在帧内 并发送出去

路由器：数据包从帧中提取出来 根据数据包中的网络地址来决定转发到哪里
交换机：帧根据MAC地址来传送 只做路由器和路由器之间的传送。

网桥：连接链路层的同类服务
路由器：连接网络层不同网络

### 5.5.3 隧道

将不同网络的数据包整个包裹传递到另一个地址

### 5.5.4 互联网路由

### 5.5.5 数据包分段

由于各种原因 数据包被限制大小

IP数据包最大为65515字节

传输大数据包要比小数据包更加节省头字节带宽

常用解决方案
1. 限制包大小
2. 数据包分段

由于数据包分段会有各种奇怪的问题，现代Internet采用路径MTU发现的手段来避免数据包在路由器中分段。

#### MTU
路径最大传输单元，即发送端到接收端的路径数据包最大可传输尺寸

#### 路径MTU发现
每个IP数据包不允许分段 在沿途的路由器中，如果遇到不可接收的路由器（数据包过大），则路由器生成报错数据包，返回至源端。然后丢弃该数据包。由源端根据报错信息来为数据包分段，使每个段都能小到报错路由器处理。如果遇到MTU更小的路由器 则重复上述过程。

## 5.6 Internet的网络层

Internet结构

1. 一级网络 由几个主要骨干网结合，骨干网由高带宽线路和快速路由器组成
2. Internet服务提供商 为家庭 企业 数据中心 服务器托管设施 以及区域网络提供Internet接入服务。

将整个Internet连结在一起的正是Internet 协议（IP，Internet Protocol）

Internet通信过程
1. 传输层获取数据流 并将数据流拆分为段
2. 将段封装为IP数据包
3. IP路由器转发每个数据包穿过Internet，沿着路径把数据包转发到下一个路由器 直到达到目的地
4. 接收方在网络层将数据交给传输层再交给接收进程

IP路由协议决定IP数据包的传输路径

### 5.6.1 IPv4协议

每个IP数据包包含头和正文

每个IP数据包头包含以下字段
1. 版本 IPv4是当前最常用的版本 IPv6是IP协议的下一个版本
2. IHL 表明头长度
3. 区分服务 前六位标记数据包服务类型 后2位携带拥塞通知信息
4. 总长度 表示数据包所有内容（即头和数据）大小
5. 标记 用来给目标主机确认该分段属于哪一个数据报
6. DF 用来告知路由器不允许分段
7. MF 告知接收方是否还有更多的段
8. 分段偏移量 指明该段在数据包中的位置
9. 生存期 用于限制数据包生存期的计数器。用于跳数计数，每过一跳 计数器减一 当计数器为0 该数据包被丢弃 并且由路由器发给源主机报警包，用于避免数据包永远停留在网络中
10. 协议字段 用于告知该数据包需要提交给那个传输进程（TCP UPD等传输层协议）
11. 头校验和， 每一跳都需要重新计算校验和 因为至少有一个字段总是在不断改变 比如生存期字段
12. 源地址 目标地址 表示源网络和目标网络的IP地址
13. 选项 该字段路由器不再被完整支持
    1.  安全性
    2.  严格源路由
    3.  松散源路由
    4.  记录路由
    5.  时间戳

### 5.6.2 IP地址

IPv4拥有一个32位地址，Internet上，每台主机和路由器都需要有一个Internet地址。IP地址并不指向主机 而是指向网络接口

#### 前缀

IP地址是层次化的地址

每个IP地址都有高位的可变长网络和低位的主机组成，同一网络上的所有主机，网络值相同。每个网络对应一块连续IP地址空间，这块地址空间被称为地址前缀。

层次化路由优点：路由器仅根据地址的网络部分即可转发数据包。这使得路由表数据量大大减少

层次化路由缺点：
1. 需要注意移动IP在不同的网络间移动，但要保持相同的IP地址
2. 层次路由浪费地址

### 。。。。一大堆 看不动了

### 5.6.3 IPv6协议

IPv6协议要解决的主要问题就是 IPv4协议的地址即将弹尽粮绝。


IPv6协议主要解决了
1. IPv6地址提供了更长的地址 IPv4使用32位地址 IPv6协议使用128位地址
2. 对头字段进行了简化，从而提高路由器吞吐量
3. 更好的支持选项
4. 对安全性的改进 这一系列改进后来也被引入IPv4中，所以安全性方面，相差不大
5. 提高了服务质量

#### 主要的IPv6头

1. Version v4总是4 v6总是6
2. 区分服务 用来区分数据包服务类型 最低两位用来表示显式拥塞指令
3. 流标签
4. 有效载荷长度 表明除头之外 还有多少字节数
5. Next header 指明当前头之后 还有哪些拓展头，如果当前是最后一个IP头 那么该字段指定该数据包将被传输到哪个传输协议处理（TCP UDP）
6. 跳数限制 与IPv4中生存期含义一致
7. 源地址和目标地址

IPv4相比IPv6的头被去除了哪些字段

1. IHL字段被去除 因为IPv6头长度固定
2. 协议字段被去除，因为Next Header可以实现相同的作用
3. 分段相关字段被去除 因为改变了分段方案，让主机从一开始就发送合适大小的数据包
4. 校验和字段被去除，计算校验和会极大降低性能 依赖数据链路层和传输层的校验和就满足目标。

